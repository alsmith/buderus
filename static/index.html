<!doctype html>
<html>
<head>
<title>Buderus GB192-25i H</title>
<script src="jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="style.css">
<script type="text/javascript" src="jquery.jqplot.min.js"></script>
<script type="text/javascript" src="plugins/jqplot.dateAxisRenderer.js"></script>
<script type="text/javascript" src="plugins/jqplot.pointLabels.js"></script>
<link rel="stylesheet" type="text/css" href="jquery.jqplot.min.css">
<link rel="stylesheet" type="text/css" href="style.css">
<script>
var solarTemps = null;
var solarData = null;
var heatingTemps = null;
var systemData = null;

var data = null;
var now = Date.now();
var offset = 0;

var refreshTimer = null;
var refreshInterval = 30;

var solarTimer1 = null;
var solarTimer2 = null;
var heatingTimer = null;
var systemTimer = null;
var graphInterval = 100;

function getAnchor() {
  if (window.location.hash != null && window.location.hash.length > 0) {
    anchor = window.location.hash;
    if (anchor.slice(0, 1) == '#') {
      anchor = anchor.slice(1);
    }
  } else {
    anchor = null;
  }
  return anchor;
}

function setAnchor(anchor) {
  window.location.hash = anchor;
}

function clearData(text) {
  if (solarTemps != null) {
    solarTemps.destroy();
    solarTemps = null;
  }
  if (solarData != null) {
    solarData.destroy();
    solarData = null;
  }
  if (heatingTemps != null) {
    heatingTemps.destroy();
    heatingTemps = null;
  }
  if (systemData != null) {
    systemData.destroy();
    systemData = null;
  }
  $('#date').html('');
  $('#status').html(text);
  if (text == '') {
    $('#statusRow').hide();
  } else {
    $('#statusRow').show();
  }
  $('#graphs').hide();
}

function generateURL() {
  var url = 'api/buderus/1.0/data';

  anchor = getAnchor();
  if (anchor != null) {
    url += '?date='+anchor;
    offset = dateToOffset(anchor);
  }
  return url;
}

function summarise(series, unit) {
  if (series == null || series.length == 0) {
    stats = {cur: 0, min: 0, max: 0};
  } else {
    stats = {}
    stats.cur = series[series.length-1][1];
    stats.min = stats.max = series[0][1];
    series.forEach(function(value, index, array) {
      if (value[1] < stats.min) {
        stats.min = value[1];
      }
      if (value[1] > stats.max) {
        stats.max = value[1];
      }
    });
  }

  text = '('+stats.cur+unit;
  if (stats.min < stats.cur) {
    text += ', low '+stats.min+unit;
  }
  if (stats.max > stats.cur) {
    text += ', high '+stats.max+unit;
  }
  text += ')'
  return text;
}

function displaySolarData1() {
  clearTimers();

  $('#graphs').show();
  if (data['dhwCircuits.dhw1.temperatureLevels.high'] == null) {
    data['dhwCircuits.dhw1.temperatureLevels.high'] = [[]];
  }

  if (solarTemps != null) {
    solarTemps.destroy();
    solarTemps = null;
  }
  solarTemps = $.jqplot('solarTemps', [data['dhwCircuits.dhw1.temperatureLevels.high'],
                                       data['solarCircuits.sc1.collectorTemperature'],
                                       data['system.sensors.temperatures.hotWater_t2'],
                                       data['solarCircuits.sc1.dhwTankTemperature'],
                                       data['system.sensors.temperatures.outdoor_t1']], {
    title: 'Solar',
    width: 800,
    seriesDefaults: { 
      showMarker: false,
    },
    legend: {
      show: true,
      placement: 'outside'
    },
    series: [ 
      {label: 'Water setpoint '+summarise(data['dhwCircuits.dhw1.temperatureLevels.high'], '&deg;C')},
      {label: 'Solar collector '+summarise(data['solarCircuits.sc1.collectorTemperature'], '&deg;C')},
      {label: 'Upper tank (boiler) '+summarise(data['system.sensors.temperatures.hotWater_t2'], '&deg;C')},
      {label: 'Lower tank (solar) '+summarise(data['solarCircuits.sc1.dhwTankTemperature'], '&deg;C')},
      {label: 'Outside temperature '+summarise(data['system.sensors.temperatures.outdoor_t1'], '&deg;C')}, // pointLabels: { show: true }
    ],
    axes: {
      xaxis: {
        renderer: $.jqplot.DateAxisRenderer
      },
    },
  });
  solarTimer2 = setInterval(displaySolarData2, graphInterval);
}

function displaySolarData2() {
  clearTimers();

  if (solarData != null) {
    solarData.destroy();
    solarData = null;
  }
  solarData = $.jqplot('solarData', [data['solarCircuits.sc1.pumpModulation'],
                                     data['solarCircuits.sc1.solarYield']], {
    width: 800,
    seriesDefaults: { 
      showMarker: false,
    },
    legend: {
      show: true,
      placement: 'outside'
    },
    series: [ 
      {label: 'Solar pump output '+summarise(data['solarCircuits.sc1.pumpModulation'], '%')},
      {label: 'Solar yield '+summarise(data['solarCircuits.sc1.solarYield'], 'Wh')},
    ],
    axes: {
      xaxis: {
        renderer: $.jqplot.DateAxisRenderer
      },
      yaxis: {
        min: 0
      },
    },
  });
  heatingTimer = setInterval(displayHeatingData, graphInterval);
}

function displayHeatingData() {
  clearTimers();

  if (heatingTemps != null) {
    heatingTemps.destroy();
    heatingTemps = null;
  }
  heatingTemps = $.jqplot('heatingTemps', [data['system.sensors.temperatures.supply_t1'],
                                           data['system.sensors.temperatures.return'],
                                           data['heatingCircuits.hc1.actualSupplyTemperature'],
                                           data['heatingCircuits.hc1.temperatureLevels.comfort2'],
                                           data['heatingCircuits.hc1.temperatureLevels.eco'],
                                           data['heatingCircuits.hc1.roomtemperature'],
                                           data['system.sensors.temperatures.outdoor_t1']], {
    title: 'Heating',
    width: 800,
    seriesDefaults: { 
      showMarker: false,
    },
    legend: {
      show: true,
      placement: 'outside'
    },
    series: [ 
      {label: 'Boiler output '+summarise(data['system.sensors.temperatures.supply_t1'], '&deg;C')},
      {label: 'Boiler return '+summarise(data['system.sensors.temperatures.return'], '&deg;C')},
      {label: 'Heating supply '+summarise(data['heatingCircuits.hc1.actualSupplyTemperature'], '&deg;C')},
      {label: 'Day setpoint '+summarise(data['heatingCircuits.hc1.temperatureLevels.comfort2'], '&deg;C')},
      {label: 'Night setpoint '+summarise(data['heatingCircuits.hc1.temperatureLevels.eco'], '&deg;C')},
      {label: 'Room temperature '+summarise(data['heatingCircuits.hc1.roomtemperature'], '&deg;C')},
      {label: 'Outside temperature '+summarise(data['system.sensors.temperatures.outdoor_t1'], '&deg;C')},
    ],
    axes: {
      xaxis: {
        renderer: $.jqplot.DateAxisRenderer
      },
    },
  });
  systemTimer = setInterval(displaySystemData, graphInterval);
}

function displaySystemData() {
  clearTimers();

  if (systemData != null) {
    systemData.destroy();
    systemData = null;
  }
  systemData = $.jqplot('systemData', [data['heatSources.actualPower'],
                                       data['heatSources.actualCHPower'],
                                       data['heatSources.actualDHWPower'],
                                       data['heatSources.actualModulation'],
                                       data['heatSources.flameStatus'],
                                       data['dhwCircuits.dhw1.waterFlow'],
                                       data['heatingCircuits.hc1.pumpModulation'],
                                       data['heatSources.CHpumpModulation']], {
    title: 'System',
    width: 800,
    seriesDefaults: { 
      showMarker: false,
    },
    legend: {
      show: true,
      placement: 'outside'
    },
    series: [ 
      {label: 'Total system output '+summarise(data['heatSources.actualPower'], 'kW')},
      {label: 'Heating system '+summarise(data['heatSources.actualCHPower'], 'kW')},
      {label: 'Hot water system '+summarise(data['heatSources.actualDHWPower'], 'kW')},
      {label: 'Flame modulation '+summarise(data['heatSources.actualModulation'], '%')},
      {label: 'Flame status '+summarise(data['heatSources.flameStatus'], '')},
      {label: 'Hot water flow '+summarise(data['dhwCircuits.dhw1.waterFlow'], 'l/min')},
      {label: 'Boiler pump output '+summarise(data['heatingCircuits.hc1.pumpModulation'], '%')},
      {label: 'Heating pump output '+summarise(data['heatSources.CHpumpModulation'], '%')},
    ],
    axes: {
      xaxis: {
        renderer: $.jqplot.DateAxisRenderer
      },
      yaxis: {
        min: 0
      },
    },
  });
  refreshTimer = setInterval(displayData, refreshInterval * 1000);
}

function clearTimer(timer) {
  if (timer) {
    clearInterval(timer);
  }
  return null;
}

function clearTimers() {
  refreshTimer = clearTimer(refreshTimer);
  solarTimer1 = clearTimer(solarTimer1);
  solarTimer2 = clearTimer(solarTimer2);
  heatingTimer = clearTimer(heatingTimer);
  systemTimer = clearTimer(systemTimer);
}

function displayData() {
  clearTimers();

  $.ajax({
    dataType: 'json',
    url: generateURL()
  }).done(function(d) {
    data = d;

    if (Object.keys(data).length == 0) {
      clearData('No data to display');
      return;
    }
    $('#status').html('');
    $('#statusRow').hide();

    // Get last timestamp
    firstSeries = data[Object.keys(data)[0]]
    if (firstSeries.length > 0) {
      $('#date').html(firstSeries[firstSeries.length-1][0]);
    } else {
      $('#date').html(offsetToDate(offset));
    }

    solarTimer1 = setInterval(displaySolarData1, graphInterval);
  }).fail(function(data) {
    clearData('Error fetching data');
    refreshTimer = setInterval(displayData, 1000);
  });
}

function offsetToDate(offset) {
    d = new Date(now+offset*86400*1000);
    return d.toJSON().slice(0, 10);
}

function dateToOffset(date) {
    var d = new Date(date.replace(/-/g, '/'));
    var n = new Date(offsetToDate(0).replace(/-/g, '/'));
    return (d-n)/1000/86400;
}

function updateButtons() {
  $('#next').prop('disabled', (offset >= 0));
  if (offset == -1) {
    $('#prev').text(offsetToDate(offset - 1));
    $('#next').text('Today');
  } else if (offset == 0) {
    $('#prev').text('Yesterday');
    $('#next').text('Tomorrow');
  } else if (offset == 1) {
    $('#prev').text('Today');
    $('#next').text(offsetToDate(offset + 1));
  } else {
    $('#prev').text(offsetToDate(offset - 1));
    $('#next').text(offsetToDate(offset + 1));
  }
}

$(document).ready(function(){
  displayData();
  updateButtons();

  $('#prev').click(function() {
    offset -= 1;
    if (offset == 0) {
      setAnchor('');
    } else {
      setAnchor(offsetToDate(offset));
    }
    clearData('Fetching data...');
    updateButtons();
    displayData();
  });
  $('#next').click(function() {
    offset += 1;
    if (offset == 0) {
      setAnchor('');
    } else {
      setAnchor(offsetToDate(offset));
    }
    clearData('Fetching data...');
    updateButtons();
    displayData();
  });
});
</script>
</head>
<body>
<table id="nav" width="800">
<tr><td width="200"><button id="prev">Yesterday</button></td><td align="center"><span id="date" class="jqplot-title"></span></td><td width="200" align="right"><button id="next" disabled>Tomorrow</button></td></tr>
<tr id="statusRow"><td><span id="status">Fetching data...</span></td></tr>
</table>
<table id="graphs" style="display: none">
<tr><td><div id="solarTemps"></td></tr>
<tr><td><div id="solarData"></td></tr>
<tr><td><div id="heatingTemps"></td></tr>
<tr><td><div id="systemData"></td></tr>
</table>
<hr>
<font size="-2"><a href="https://github.com/alsmith/buderus" target="_blank">Source code</a></font>
</body>
</html>
