<!doctype html>
<html>
<head>
<title>Buderus GB192-25i H</title>
<script src="jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="style.css">
<script type="text/javascript" src="jquery.jqplot.min.js"></script>
<script type="text/javascript" src="plugins/jqplot.dateAxisRenderer.js"></script>
<script type="text/javascript" src="plugins/jqplot.pointLabels.js"></script>
<link rel="stylesheet" type="text/css" href="jquery.jqplot.min.css">
<link rel="stylesheet" type="text/css" href="style.css">
<script>
var solarTemps = null;
var solarData = null;
var heatingTemps = null;
var systemData = null;
var annualData = null;

var data = null;
var offset = 0;

var refreshTimer = null;
var refreshInterval = 30;

var solarTimer1 = null;
var solarTimer2 = null;
var heatingTimer = null;
var systemTimer = null;
var annualTimer = null;
var graphInterval = 100;

var solarTable1 =  [{key: 'dhwCircuits.dhw1.temperatureLevels.high',        label: 'Water setpoint',      unit: '&deg;C'},
                    {key: 'solarCircuits.sc1.collectorTemperature',         label: 'Solar collector',     unit: '&deg;C'},
                    {key: 'system.sensors.temperatures.hotWater_t2',        label: 'Upper tank (boiler)', unit: '&deg;C'},
                    {key: 'solarCircuits.sc1.dhwTankTemperature',           label: 'Lower tank (solar)',  unit: '&deg;C'},
                    {key: 'system.sensors.temperatures.outdoor_t1',         label: 'Outside temperature', unit: '&deg;C'}];

var solarTable2 =  [{key: 'solarCircuits.sc1.pumpModulation',               label: 'Solar pump output',   unit: '%'},
                    {key: 'solarCircuits.sc1.solarYield',                   label: 'Solar yield',         unit: 'Wh'}];

var heatingTable = [{key: 'system.sensors.temperatures.supply_t1',          label: 'Boiler output',       unit: '&deg;C'},
                    {key: 'system.sensors.temperatures.return',             label: 'Boiler return',       unit: '&deg;C'},
                    {key: 'heatingCircuits.hc1.actualSupplyTemperature',    label: 'Heating supply',      unit: '&deg;C'},
                    {key: 'heatingCircuits.hc1.temperatureLevels.comfort2', label: 'Day setpoint',        unit: '&deg;C'},
                    {key: 'heatingCircuits.hc1.temperatureLevels.eco',      label: 'Night setpoint',      unit: '&deg;C'},
                    {key: 'heatingCircuits.hc1.roomtemperature',            label: 'Room temperature',    unit: '&deg;C'},
                    {key: 'system.sensors.temperatures.outdoor_t1',         label: 'Outside temperature', unit: '&deg;C'}];

var systemTable =  [{key: 'heatSources.actualPower',                        label: 'Total system output', unit: 'kW'},
                    {key: 'heatSources.actualCHPower',                      label: 'Heating system',      unit: 'kW'},
                    {key: 'heatSources.actualDHWPower',                     label: 'Hot water system',    unit: 'kW'},
                    {key: 'heatSources.actualModulation',                   label: 'Flame modulation',    unit: '%'},
                    {key: 'heatSources.flameStatus',                        label: 'Flame status',        unit: ''},
                    {key: 'dhwCircuits.dhw1.waterFlow',                     label: 'Hot water flow',      unit: 'l/min'},
                    {key: 'heatingCircuits.hc1.pumpModulation',             label: 'Boiler pump output',  unit: '%'},
                    {key: 'heatSources.CHpumpModulation',                   label: 'Heating pump output', unit: '%'}];
var annualTable =  [{key: 'system.sensors.temperatures.outdoor_t1',         label: 'Outside temperature', unit: '&deg;C', min: true, max: true             },
                    {key: 'heatSources.systemPressure',                     label: 'System pressure',     unit: 'bar',               max: true             },
                    {key: 'heatSources.numberOfStarts',                     label: 'Burner starts',       unit: '',                             delta: true}];

function getAnchor() {
  if (window.location.hash != null && window.location.hash.length > 0) {
    anchor = window.location.hash;
    if (anchor.slice(0, 1) == '#') {
      anchor = anchor.slice(1);
    }
  } else {
    anchor = null;
  }
  return anchor;
}

function setAnchor(anchor) {
  window.location.hash = anchor;
}

function clearData(text) {
  if (solarTemps != null) {
    solarTemps.destroy();
    solarTemps = null;
  }
  if (solarData != null) {
    solarData.destroy();
    solarData = null;
  }
  if (heatingTemps != null) {
    heatingTemps.destroy();
    heatingTemps = null;
  }
  if (systemData != null) {
    systemData.destroy();
    systemData = null;
  }
  if (annualData != null) {
    annualData.destroy();
    annualData = null;
  }
  $('#date').html('');
  $('#status').html(text);
  if (text == '') {
    $('#statusRow').hide();
  } else {
    $('#statusRow').show();
  }
  $('#graphs').hide();
}

function summarise(series, unit) {
  if (series == null || series.length == 0) {
    stats = {cur: 0, min: 0, max: 0};
  } else {
    stats = {}
    stats.cur = series[series.length-1][1];
    stats.min = stats.max = series[0][1];
    series.forEach(function(value, index, array) {
      if (value[1] < stats.min) {
        stats.min = value[1];
      }
      if (value[1] > stats.max) {
        stats.max = value[1];
      }
    });
  }

  text = '('+stats.cur+unit;
  if (stats.min < stats.cur) {
    text += ', low '+stats.min+unit;
  }
  if (stats.max > stats.cur) {
    text += ', high '+stats.max+unit;
  }
  text += ')'
  return text;
}

function getKeys(table) {
  return table.map(function(i) {return i.key;});
}

function getData(table, data) {
  var rc = [];
  table.forEach(function(i) {
    if (i.min || i.max || i.delta) {
      if (i.max) {
        rc.push(data[i.key+'.max']);
      }
      if (i.min) {
        rc.push(data[i.key+'.min']);
      }
      if (i.delta) {
        rc.push(data[i.key+'.delta']);
      }
    } else {
      rc.push(data[i.key]);
    }
  });
  return rc;
}

function getLabels(table, data) {
  var rc = [];
  table.forEach(function(i) {
    if (i.min || i.max || i.delta) {
      if (i.max) {
        rc.push({label: 'Maximum '+i.label.toLowerCase()+' '+summarise(data[i.key+'.max'], i.unit)});
      }
      if (i.min) {
        rc.push({label: 'Minimum '+i.label.toLowerCase()+' '+summarise(data[i.key+'.min'], i.unit)});
      }
      if (i.delta) {
        rc.push({label: i.label+' '+summarise(data[i.key+'.delta'], i.unit)});
      }
    } else {
      rc.push({label: i.label+' '+summarise(data[i.key], i.unit)});
    }
  });
  return rc;
}

function displaySolarData1() {
  clearTimers();

  $('#graphs').show();
  if (data['dhwCircuits.dhw1.temperatureLevels.high'] == null) {
    data['dhwCircuits.dhw1.temperatureLevels.high'] = [[]];
  }

  if (solarTemps != null) {
    solarTemps.destroy();
    solarTemps = null;
  }
  solarTemps = $.jqplot('solarTemps', getData(solarTable1, data), {
    title: 'Solar',
    width: 800,
    seriesDefaults: { 
      showMarker: false,
    },
    legend: {
      show: true,
      placement: 'outside'
    },
    series: getLabels(solarTable1, data),
    axes: {
      xaxis: {
        renderer: $.jqplot.DateAxisRenderer
      },
    },
  });
  solarTimer2 = setInterval(displaySolarData2, graphInterval);
}

function displaySolarData2() {
  clearTimers();

  if (solarData != null) {
    solarData.destroy();
    solarData = null;
  }
  solarData = $.jqplot('solarData', getData(solarTable2, data), {
    width: 800,
    seriesDefaults: { 
      showMarker: false,
    },
    legend: {
      show: true,
      placement: 'outside'
    },
    series: getLabels(solarTable2, data),
    axes: {
      xaxis: {
        renderer: $.jqplot.DateAxisRenderer
      },
      yaxis: {
        min: 0
      },
    },
  });
  heatingTimer = setInterval(displayHeatingData, graphInterval);
}

function displayHeatingData() {
  clearTimers();

  if (heatingTemps != null) {
    heatingTemps.destroy();
    heatingTemps = null;
  }
  heatingTemps = $.jqplot('heatingTemps', getData(heatingTable, data), {
    title: 'Heating',
    width: 800,
    seriesDefaults: { 
      showMarker: false,
    },
    legend: {
      show: true,
      placement: 'outside'
    },
    series: getLabels(heatingTable, data),
    axes: {
      xaxis: {
        renderer: $.jqplot.DateAxisRenderer
      },
    },
  });
  systemTimer = setInterval(displaySystemData, graphInterval);
}

function displaySystemData() {
  clearTimers();

  if (systemData != null) {
    systemData.destroy();
    systemData = null;
  }
  systemData = $.jqplot('systemData', getData(systemTable, data), {
    title: 'System',
    width: 800,
    seriesDefaults: { 
      showMarker: false,
    },
    legend: {
      show: true,
      placement: 'outside'
    },
    series: getLabels(systemTable, data),
    axes: {
      xaxis: {
        renderer: $.jqplot.DateAxisRenderer
      },
      yaxis: {
        min: 0
      },
    },
  });
  annualTimer = setInterval(displayAnnualData, graphInterval);
}

function displayAnnualData() {
  clearTimers();
  if (annualData != null) {
    annualData.destroy();
    annualData = null;
  }
  annualData = $.jqplot('annualData', getData(annualTable, data), {
    title: 'Annual summary',
    width: 800,
    seriesDefaults: { 
      showMarker: false,
    },
    legend: {
      show: true,
      placement: 'outside'
    },
    series: getLabels(annualTable, data),
    axes: {
      xaxis: {
        renderer: $.jqplot.DateAxisRenderer
      },
      yaxis: {
        min: 0
      },
    },
  });
  refreshTimer = setInterval(displayData, refreshInterval * 1000);
}

function clearTimer(timer) {
  if (timer) {
    clearInterval(timer);
  }
  return null;
}

function clearTimers() {
  refreshTimer = clearTimer(refreshTimer);
  solarTimer1 = clearTimer(solarTimer1);
  solarTimer2 = clearTimer(solarTimer2);
  heatingTimer = clearTimer(heatingTimer);
  systemTimer = clearTimer(systemTimer);
  annualTimer = clearTimer(annualTimer);
}

function displayData() {
  clearTimers();

  postData = {};
  anchor = getAnchor();
  if (anchor != null) {
    postData.date = anchor;
    offset = dateToOffset(anchor);
  }
  postData.dayKeys = [];
  postData.dayKeys = postData.dayKeys.concat(getKeys(solarTable1));
  postData.dayKeys = postData.dayKeys.concat(getKeys(solarTable2));
  postData.dayKeys = postData.dayKeys.concat(getKeys(heatingTable));
  postData.dayKeys = postData.dayKeys.concat(getKeys(systemTable));

  postData.yearKeys = [];
  postData.yearKeys = postData.yearKeys.concat(getKeys(annualTable));

  $.ajax({
    dataType: 'json',
    url: 'api/buderus/1.0/data',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(postData)
  }).done(function(d) {
    data = d;

    if (Object.keys(data).length == 0) {
      clearData('No data to display');
      return;
    }
    $('#status').html('');
    $('#statusRow').hide();

    // Get last timestamp
    firstSeries = data[Object.keys(data)[0]]
    if (firstSeries.length > 0) {
      $('#date').html(firstSeries[firstSeries.length-1][0]);
    } else {
      $('#date').html(offsetToDate(offset));
    }

    solarTimer1 = setInterval(displaySolarData1, graphInterval);
  }).fail(function(data) {
    clearData('Error fetching data');
    refreshTimer = setInterval(displayData, 1000);
  });
}

function offsetToDate(offset) {
    d = new Date(Date.now()+offset*86400*1000);
    return d.toJSON().slice(0, 10);
}

function dateToOffset(date) {
    var d = new Date(date.replace(/-/g, '/'));
    var n = new Date(offsetToDate(0).replace(/-/g, '/'));
    return (d-n)/1000/86400;
}

function updateButtons() {
  $('#next').prop('disabled', (offset >= 0));
  if (offset == -1) {
    $('#prev').text(offsetToDate(offset - 1));
    $('#next').text('Today');
  } else if (offset == 0) {
    $('#prev').text('Yesterday');
    $('#next').text('Tomorrow');
  } else if (offset == 1) {
    $('#prev').text('Today');
    $('#next').text(offsetToDate(offset + 1));
  } else {
    $('#prev').text(offsetToDate(offset - 1));
    $('#next').text(offsetToDate(offset + 1));
  }
}

$(document).ready(function(){
  displayData();
  updateButtons();

  $('#prev').click(function() {
    offset -= 1;
    if (offset == 0) {
      setAnchor('');
    } else {
      setAnchor(offsetToDate(offset));
    }
    clearData('Fetching data...');
    updateButtons();
    displayData();
  });
  $('#next').click(function() {
    offset += 1;
    if (offset == 0) {
      setAnchor('');
    } else {
      setAnchor(offsetToDate(offset));
    }
    clearData('Fetching data...');
    updateButtons();
    displayData();
  });
});
</script>
</head>
<body>
<table id="nav" width="800">
<tr><td width="200"><button id="prev">Yesterday</button></td><td align="center"><span id="date" class="jqplot-title"></span></td><td width="200" align="right"><button id="next" disabled>Tomorrow</button></td></tr>
<tr id="statusRow"><td><span id="status">Fetching data...</span></td></tr>
</table>
<table id="graphs" style="display: none">
<tr><td><div id="solarTemps"></td></tr>
<tr><td><div id="solarData"></td></tr>
<tr><td><div id="heatingTemps"></td></tr>
<tr><td><div id="systemData"></td></tr>
<tr><td><div id="annualData"></td></tr>
</table>
<hr>
<font size="-2"><a href="https://github.com/alsmith/buderus" target="_blank">Source code</a></font>
</body>
</html>
